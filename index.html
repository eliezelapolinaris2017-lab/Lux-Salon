<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Salón – Agenda & Facturación (PWA)</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e1a24">
<style>
  :root{
    --bg:#0e1a24; --panel:#0f2230; --panel2:#0c1c28;
    --ink:#e8f0f6; --muted:#a6bdcc; --accent:#4cc2ff;
    --ok:#32d296; --warn:#ffcf44; --danger:#ff5678;
    --line:#163042; --btn:#15374a; --btn-ink:#e8f0f6;
    --brand:#e8f0f6; --topbar:#0f2230;
    --card-radius:14px; --gap:14px;
    --font: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:15px/1.45 var(--font); color:var(--ink);
    background: radial-gradient(1200px 1200px at 15% 10%,#0c1a24 0,#071018 60%,#040a10 100%);
  }
  .topbar{position:sticky; top:0; z-index:10; display:flex; align-items:center; gap:10px; padding:10px 14px; background:var(--topbar); border-bottom:1px solid var(--line)}
  .topbar .brand{display:flex; align-items:center; gap:10px; flex:1}
  .topbar img.logo{height:32px; width:auto; object-fit:contain}
  .topbar h1{font-size:16px; margin:0; color:var(--brand); font-weight:600; letter-spacing:.3px}
  .topbar .menu-btn{appearance:none; border:1px solid var(--line); background:var(--btn); color:var(--btn-ink); border-radius:10px; padding:8px 12px; cursor:pointer}
  .wrap{max-width:1100px; margin:0 auto; padding:16px}
  .hidden{display:none !important}
  .view{background:linear-gradient(180deg, rgba(255,255,255,0.04), transparent 120px), var(--panel); border:1px solid var(--line); border-radius:var(--card-radius); padding:18px; margin-top:16px}
  .view header{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
  .view header h2{margin:0; font-size:18px}
  .back-btn{appearance:none; background:transparent; color:var(--muted); border:1px solid var(--line); border-radius:10px; padding:6px 10px; cursor:pointer}
  .menu-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:var(--gap); margin-top:8px}
  .menu-card{background:var(--panel2); border:1px solid var(--line); padding:16px; border-radius:var(--card-radius); cursor:pointer; display:flex; gap:12px; align-items:flex-start; transition:transform .05s ease}
  .menu-card:hover{transform:translateY(-1px)}
  .menu-card .ico{font-size:20px}
  .muted{color:var(--muted); font-size:13px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .row > *{flex:1}
  label{font-size:13px; color:var(--muted)}
  input,select,textarea{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0b1a24; color:var(--ink)}
  textarea{min-height:84px; resize:vertical}
  .btn{appearance:none; border:1px solid var(--line); background:var(--btn); color:var(--btn-ink); border-radius:10px; padding:10px 14px; cursor:pointer}
  .btn.ok{background:var(--ok); color:#032216; border-color:#0b4e3b}
  .btn.warn{background:var(--warn); color:#2a2000; border-color:#665100}
  .btn.danger{background:var(--danger); color:#2e000a; border-color:#5a0018}
  .table{width:100%; border-collapse:collapse; border:1px solid var(--line); margin-top:10px}
  .table th,.table td{border-bottom:1px solid var(--line); padding:8px 10px; text-align:left; font-size:14px}
  .pill{display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--line); font-size:12px; color:var(--muted)}
  .notice{padding:10px 12px; border:1px dashed var(--line); border-radius:10px; background:#0a1520; color:var(--muted); font-size:13px}
  .two{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
  @media (max-width:860px){.two{grid-template-columns:1fr}}
  @media print{
    body{background:#fff; color:#000}
    .topbar,.back-btn,.menu-grid,.no-print{display:none !important}
    .view{border:none; padding:0; margin:0}
    .invoice-sheet{border:1px solid #000; padding:24px}
    .invoice-header{display:flex; justify-content:space-between; align-items:flex-start}
    .invoice-title{font-weight:700; font-size:20px}
    .invoice-logo{height:48px}
    .invoice-table{width:100%; border-collapse:collapse; margin-top:16px}
    .invoice-table th,.invoice-table td{border:1px solid #000; padding:8px; font-size:12px}
  }
  .footer{margin:24px auto; text-align:center; color:var(--muted); font-size:12px}
  .footer img{height:22px; opacity:.9}
  .color-row{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <img id="logoHeader" class="logo" alt="logo" src="" />
      <h1 id="brandName">Mi Salón</h1>
    </div>
    <button class="menu-btn" id="btnGoMenu">Menú</button>
  </div>

  <div class="wrap">

    <!-- LOGIN -->
    <section id="viewLogin" class="view">
      <header><h2>Iniciar sesión</h2></header>
      <div class="two">
        <div>
          <label>Usuario</label>
          <input id="loginUser" autocomplete="username" placeholder="usuario">
        </div>
        <div>
          <label>Contraseña</label>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn ok" id="btnLogin">Entrar</button>
        <button class="btn" id="btnReset">Restablecer (admin/admin)</button>
        <span class="muted">Rol Admin verá Configuración, Rendimiento y Cuadre.</span>
      </div>
      <div class="notice" style="margin-top:12px">
        Primer uso: usuario <b>admin</b> / contraseña <b>admin</b>. Puedes cambiarlos en Configuración &gt; Usuarios.
      </div>
    </section>

    <!-- MENÚ -->
    <section id="viewMenu" class="view hidden">
      <header>
        <h2>Dashboard</h2>
        <button class="back-btn hidden" data-back>Regresar</button>
      </header>
      <div id="menuGrid" class="menu-grid"></div>
      <div class="footer no-print">
        <img id="logoFooter" alt="footer" src="">
        <div id="footerText" class="muted"></div>
      </div>
    </section>

    <!-- AGENDA -->
    <section id="viewAgenda" class="view hidden">
      <header>
        <h2>Agendar Cita</h2>
        <button class="back-btn" data-back>Regresar</button>
      </header>
      <div class="two">
        <div><label>Cliente</label><input id="ag_cliente" placeholder="Nombre del cliente"></div>
        <div><label>Teléfono</label><input id="ag_tel" placeholder="7870000000"></div>
        <div><label>Técnica / Estilista</label><select id="ag_tech"></select></div>
        <div><label>Servicio</label><select id="ag_serv"></select></div>
        <div><label>Fecha</label><input id="ag_fecha" type="date"></div>
        <div><label>Hora</label><input id="ag_hora" type="time"></div>
      </div>
      <label style="margin-top:8px; display:block">Notas</label>
      <textarea id="ag_notas" placeholder="Observaciones"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn ok" id="btnGuardarCita">Guardar</button>
        <button class="btn" id="btnAddCalendar" title="Añadir a Google Calendar">Google Calendar</button>
        <button class="btn" id="btnWhatsCita" title="Enviar WhatsApp">WhatsApp</button>
      </div>

      <h3 style="margin-top:18px">Citas (buscar / editar / no-show)</h3>
      <div class="row">
        <input id="filtroCitas" placeholder="Busca por cliente o fecha (YYYY-MM-DD)">
        <button class="btn" id="btnFiltrarCitas">Filtrar</button>
        <button class="btn warn" id="btnRecordatorios24">Recordatorios 24h</button>
      </div>
      <table class="table" id="tablaCitas">
        <thead><tr><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Técnica</th><th>Servicio</th><th>Estado</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- FECHAS DISPONIBLES -->
    <section id="viewFechas" class="view hidden">
      <header>
        <h2>Fechas disponibles</h2>
        <button class="back-btn" data-back>Regresar</button>
      </header>
      <div class="row">
        <select id="fd_tech"></select>
        <input id="fd_fecha" type="date">
        <input id="fd_inicio" type="time" value="09:00">
        <input id="fd_fin" type="time" value="17:00">
        <input id="fd_intervalo" type="number" min="15" step="15" value="60">
        <button class="btn" id="btnCalcularSlots">Mostrar</button>
      </div>
      <table class="table" id="tablaSlots">
        <thead><tr><th>Hora</th><th>Estado</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="notice">Se marcan ocupadas si existe una cita con la misma <b>técnica</b>, <b>cliente</b> y <b>hora</b> ese día.</div>
    </section>

    <!-- NO SHOW -->
    <section id="viewNoShow" class="view hidden">
      <header>
        <h2>No-Show</h2>
        <button class="back-btn" data-back>Regresar</button>
      </header>
      <div class="notice">Marca/Desmarca como No-Show desde la tabla de Citas. Aquí verás el histórico.</div>
      <table class="table" id="tablaNoShow">
        <thead><tr><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Técnica</th><th>Servicio</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- COBROS & FACTURAS -->
    <section id="viewCobros" class="view hidden">
      <header>
        <h2>Cobros & Facturas</h2>
        <button class="back-btn" data-back>Regresar</button>
      </header>
      <div class="two">
        <div><label>Cliente</label><input id="co_cliente" placeholder="Nombre del cliente"></div>
        <div><label>Teléfono</label><input id="co_tel" placeholder="7870000000"></div>
        <div><label>Técnica</label><select id="co_tech"></select></div>
        <div>
          <label>Método de pago</label>
          <select id="co_metodo"><option>ATH Móvil</option><option>Tarjeta</option><option>Cash</option></select>
        </div>
      </div>

      <h3 style="margin-top:12px">Servicios (editables)</h3>
      <div class="row">
        <select id="co_servSelect"></select>
        <input id="co_qty" type="number" min="1" value="1">
        <input id="co_precio" type="number" step="0.01" placeholder="Precio">
        <button class="btn" id="btnAddItem">Añadir</button>
      </div>

      <table class="table" id="tablaItems">
        <thead><tr><th>Servicio</th><th>Cant.</th><th>Precio</th><th>Subtotal</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row" style="justify-content:flex-end">
        <div class="pill">Total: <span id="co_total">0.00</span></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn ok" id="btnGuardarFactura">Guardar</button>
        <button class="btn" id="btnWhatsFactura">WhatsApp</button>
        <button class="btn" id="btnPrintFactura">PDF premium</button>
        <button class="btn" id="btnEnviarCuadre">Enviar a Hoja de Cuadre</button>
      </div>

      <h3 style="margin-top:18px">Historial de Facturas/Cobros</h3>
      <div class="row no-print">
        <button class="btn" id="expCobrosPDF">Exportar PDF</button>
        <button class="btn" id="expCobrosCSV">Exportar CSV</button>
        <button class="btn" id="expCobrosJSON">Exportar JSON</button>
      </div>
      <table class="table" id="tablaCobros">
        <thead><tr><th>#</th><th>Fecha</th><th>Cliente</th><th>Técnica</th><th>Método</th><th>Total</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="notice">Ver hoja: 
        <a target="_blank" id="cuadreLink" href="https://docs.google.com/spreadsheets/d/1-MxlLqk6BLkYiThYros0F3DLCef0jd5tV-pUilMk3iM/edit">
          Hoja de Cuadre Diario (Google Sheets)
        </a>. Webhook (Apps Script) configurable en <b>Configuración &gt; Integraciones</b>.
      </div>

      <div id="invoicePrint" class="invoice-sheet hidden">
        <div class="invoice-header">
          <div>
            <div class="invoice-title" id="inv_title">FACTURA</div>
            <div id="inv_salon">Mi Salón</div>
            <div id="inv_meta" class="muted">Fecha: <span id="inv_fecha"></span> · Factura: <span id="inv_nro"></span></div>
          </div>
          <img id="inv_logo" class="invoice-logo" alt="">
        </div>
        <div style="margin-top:12px"><b>Cliente:</b> <span id="inv_cliente"></span> · <b>Tel:</b> <span id="inv_tel"></span></div>
        <table class="invoice-table" style="margin-top:12px">
          <thead><tr><th>#</th><th>Servicio</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr></thead>
          <tbody id="inv_body"></tbody>
          <tfoot><tr><td colspan="4" style="text-align:right"><b>Total</b></td><td id="inv_total"></td></tr></tfoot>
        </table>
        <div style="margin-top:12px; font-size:12px" id="inv_footer">Gracias por su preferencia.</div>
      </div>
    </section>

    <!-- RENDIMIENTO -->
    <section id="viewRend" class="view hidden">
      <header>
        <h2>Rendimiento</h2>
        <button class="back-btn" data-back>Regresar</button>
      </header>
      <div class="row">
        <label>Periodo</label>
        <select id="rn_periodo"><option value="dia">Diario</option><option value="sem">Semanal</option><option value="mes" selected>Mensual</option></select>
        <select id="rn_techFiltro"></select>
        <button class="btn" id="btnCalcRend">Actualizar</button>
        <button class="btn" id="btnExpRendJSON">Exportar JSON</button>
        <button class="btn" id="btnPrintRend">PDF</button>
      </div>
      <canvas id="chartRend" width="900" height="360" style="margin-top:10px; background:#0b1a24; border:1px solid var(--line); border-radius:10px"></canvas>
      <div id="rendResumen" class="muted" style="margin-top:8px"></div>
    </section>

    <!-- CONFIGURACIÓN -->
    <section id="viewConfig" class="view hidden">
      <header>
        <h2>Configuración</h2>
        <button class="back-btn" data-back>Regresar</button>
      </header>

      <h3>Identidad</h3>
      <div class="two">
        <div><label>Nombre del salón</label><input id="cf_brandName" placeholder="Nombre"></div>
        <div><label>Footer (texto)</label><input id="cf_footerText" placeholder="Dirección / Teléfono / Web"></div>
      </div>
      <div class="two" style="margin-top:10px">
        <div><label>Logo Header (sube imagen)</label><input id="cf_logoHeader" type="file" accept="image/*"></div>
        <div><label>Logo Footer (sube imagen)</label><input id="cf_logoFooter" type="file" accept="image/*"></div>
      </div>

      <h3 style="margin-top:16px">Diseño</h3>
      <div class="color-row">
        <div><label>Color fondo (—bg)</label><input id="cf_bg" type="color"></div>
        <div><label>Color topbar</label><input id="cf_topbar" type="color"></div>
        <div><label>Color botones</label><input id="cf_btn" type="color"></div>
        <div><label>Color textos</label><input id="cf_ink" type="color"></div>
      </div>
      <div class="two" style="margin-top:10px">
        <div><label>Fuente (ej: system-ui)</label><input id="cf_font" placeholder="system-ui"></div>
        <div><label>Imagen de fondo (opcional)</label><input id="cf_bgImage" type="file" accept="image/*"></div>
      </div>

      <h3 style="margin-top:16px">Usuarios & Roles</h3>
      <div class="row">
        <input id="cf_user" placeholder="usuario">
        <input id="cf_pass" placeholder="contraseña">
        <select id="cf_role"><option>admin</option><option>regular</option></select>
        <button class="btn" id="btnAddUser">Añadir</button>
      </div>
      <table class="table" id="tablaUsers"><thead><tr><th>Usuario</th><th>Rol</th><th></th></tr></thead><tbody></tbody></table>

      <h3 style="margin-top:16px">Técnicas / Estilistas</h3>
      <div class="row"><input id="cf_tech" placeholder="Nombre"><button class="btn" id="btnAddTech">Añadir</button></div>
      <table class="table" id="tablaTechs"><thead><tr><th>Nombre</th><th></th></tr></thead><tbody></tbody></table>

      <h3 style="margin-top:16px">Servicios (precios base)</h3>
      <div class="two"><input id="cf_srvNombre" placeholder="Servicio"><input id="cf_srvPrecio" type="number" step="0.01" placeholder="Precio"></div>
      <div class="row" style="margin-top:8px"><button class="btn" id="btnAddSrv">Añadir</button></div>
      <table class="table" id="tablaSrv"><thead><tr><th>Servicio</th><th>Precio</th><th></th></tr></thead><tbody></tbody></table>

      <h3 style="margin-top:16px">Integraciones</h3>
      <div class="two">
        <div><label>Teléfono WhatsApp (solo dígitos)</label><input id="cf_whatsTel" placeholder="7876643079"></div>
        <div><label>Ubicación (texto/link para mensaje)</label><input id="cf_whatsUbic" placeholder="Trujillo Alto, PR"></div>
      </div>
      <div class="two" style="margin-top:10px">
        <div><label>URL Hoja de Cuadre (ver)</label><input id="cf_sheetsURL" placeholder="https://docs.google.com/spreadsheets/..."></div>
        <div><label>Webhook (Apps Script) para enviar cobros</label><input id="cf_webhookURL" placeholder="https://script.google.com/macros/s/XXX/exec"></div>
      </div>

      <h3 style="margin-top:16px">Backups & Exportes</h3>
      <div class="row">
        <button class="btn" id="btnExpConfig">Exportar Config JSON</button>
        <button class="btn" id="btnImpConfig">Importar Config JSON</button>
        <input id="cf_importFile" type="file" accept="application/json" class="hidden">
        <button class="btn" id="btnExpDatos">Exportar Datos (citas/cobros/no-shows) JSON</button>
        <button class="btn" id="btnExpDatosCSV">Exportar Datos CSV</button>
        <button class="btn" id="btnPrintConfig">Imprimir PDF resumen</button>
      </div>
    </section>
  </div>

<script>
/* =========================
   UTIL & PERSISTENCIA
========================= */
const APP_KEY='salon_app_v1';
const state = {
  user:null, role:null,
  settings:null, techs:[], services:[], users:[],
  appointments:[], payments:[], logs:[],
  invoiceSeq:1
};
function saveAll(){
  localStorage.setItem(APP_KEY, JSON.stringify({
    settings:state.settings, techs:state.techs, services:state.services, users:state.users,
    appointments:state.appointments, payments:state.payments, logs:state.logs, invoiceSeq:state.invoiceSeq
  }));
}
// ---- FIX: loadAll con autocura y siembra admin/admin
function loadAll(){
  let o=null;
  try{
    const d=localStorage.getItem(APP_KEY);
    o = d ? JSON.parse(d) : null;
  }catch(e){
    localStorage.removeItem(APP_KEY);
    o=null;
  }
  if(o){
    state.settings=o.settings || defaultSettings();
    state.techs=o.techs || [];
    state.services=o.services || [];
    state.users=o.users || [];
    state.appointments=o.appointments || [];
    state.payments=o.payments || [];
    state.logs=o.logs || [];
    state.invoiceSeq=o.invoiceSeq || 1;
  }else{
    state.settings=defaultSettings();
    state.techs=[{id:id(), nombre:'General', activo:true}];
    state.services=[{id:id(), nombre:'Servicio básico', precio:25, activo:true}];
    state.users=[];
    state.appointments=[]; state.payments=[]; state.logs=[]; state.invoiceSeq=1;
  }
  // Autocura: si no hay usuarios válidos, sembrar admin/admin
  if(!Array.isArray(state.users) || state.users.length===0){
    state.users=[{id:id(), user:'admin', passHash:hash('admin'), role:'admin'}];
  }
  saveAll();
}
function defaultSettings(){
  return {
    brandName:'Mi Salón',
    footerText:'(787) 000-0000 · www.misalon.com',
    logos:{header:'', footer:''},
    colors:{bg:'#0e1a24', topbar:'#0f2230', buttons:'#15374a', ink:'#e8f0f6'},
    font:'system-ui', bgImage:'',
    menuOrder:['agenda','fechas','noshow','recordatorios','cobros','rend','cuadre','config','salir'],
    phoneWhatsApp:'7876643079', locationText:'Trujillo Alto, Puerto Rico',
    sheetsURL:'https://docs.google.com/spreadsheets/d/1-MxlLqk6BLkYiThYros0F3DLCef0jd5tV-pUilMk3iM/edit',
    webhookURL:''
  }
}
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
function id(){return Math.random().toString(36).slice(2,9)}
function hash(s){let h=0; for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i); h|=0} return String(h)}
function fmt(n){return (Math.round(n*100)/100).toFixed(2)}
function todayISO(){return new Date().toISOString().slice(0,10)}
function timeNow(){const d=new Date(); return d.toTimeString().slice(0,5)}
function download(name,content,type='application/json'){const blob=new Blob([content],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);}
function imgToDataURL(file, cb){const r=new FileReader(); r.onload=()=>cb(r.result); r.readAsDataURL(file);}
function setTheme(){
  document.documentElement.style.setProperty('--bg', state.settings.colors.bg);
  document.documentElement.style.setProperty('--topbar', state.settings.colors.topbar);
  document.documentElement.style.setProperty('--btn', state.settings.colors.buttons);
  document.documentElement.style.setProperty('--ink', state.settings.colors.ink);
  document.documentElement.style.setProperty('--font', state.settings.font);
  $('#brandName').textContent = state.settings.brandName;
  $('#logoHeader').src = state.settings.logos.header || '';
  $('#logoFooter').src = state.settings.logos.footer || '';
  $('#footerText').textContent = state.settings.footerText || '';
}

/* =========================
   NAVEGACIÓN / ROLES
========================= */
const views = {
  login: $('#viewLogin'), menu: $('#viewMenu'),
  agenda: $('#viewAgenda'), fechas: $('#viewFechas'),
  noshow: $('#viewNoShow'), cobros: $('#viewCobros'),
  rend: $('#viewRend'), config: $('#viewConfig')
};
function show(v){ Object.values(views).forEach(x=>x.classList.add('hidden')); v.classList.remove('hidden'); }
function requireAdmin(){ if(state.role!=='admin'){ alert('Acceso restringido (solo administradores).'); return false;} return true; }

/* =========================
   ARRANQUE
========================= */
loadAll(); setTheme(); renderMenu(); show(views.login);

/* =========================
   LOGIN (FIX: tolerante y reset)
========================= */
$('#btnLogin').onclick=()=>{
  const uIn = $('#loginUser').value.trim().toLowerCase();
  const pIn = $('#loginPass').value;
  if(!uIn || !pIn){ alert('Escribe usuario y contraseña'); return; }
  const entry = state.users.find(x => (x.user||'').toLowerCase() === uIn);
  const ok = entry && (
    entry.passHash === hash(pIn) || // nuevo
    entry.passHash === pIn ||       // por si quedó en texto plano
    entry.pass === hash(pIn) ||     // compat antiguos
    entry.pass === pIn              // compat muy antiguos
  );
  if(!ok){ alert('Usuario o contraseña inválidos'); return; }
  state.user = entry.user; state.role = entry.role || 'regular';
  state.logs.push({id:id(), tipo:'login', user:entry.user, fechaISO:new Date().toISOString(), detalle:'login ok'});
  saveAll(); show(views.menu); renderMenu();
};
['loginUser','loginPass'].forEach(id=> $('#'+id).addEventListener('keydown', e=>{ if(e.key==='Enter') $('#btnLogin').click(); }));
$('#btnReset').onclick=()=>{
  if(confirm('Esto reinicia los datos locales (no afecta GitHub). ¿Continuar?')){
    localStorage.removeItem(APP_KEY); location.reload();
  }
};

/* =========================
   MENÚ
========================= */
const MENU_META = {
  agenda:{ico:'📅', title:'Agendar Cita', view:views.agenda},
  fechas:{ico:'🕒', title:'Fechas Disponibles', view:views.fechas},
  noshow:{ico:'🚫', title:'No-Show', view:views.noshow},
  recordatorios:{ico:'⏰', title:'Recordatorios 24h', view:views.agenda, jump:'#record'},
  cobros:{ico:'🧾', title:'Cobros & Facturas', view:views.cobros},
  rend:{ico:'📈', title:'Rendimiento', view:views.rend, admin:true},
  cuadre:{ico:'📄', title:'Hoja de Cuadre Diario (Sheets)', href:()=>state.settings.sheetsURL},
  config:{ico:'⚙️', title:'Configuración', view:views.config, admin:true},
  salir:{ico:'🔐', title:'Cerrar sesión', action:()=>{state.user=null; state.role=null; show(views.login)}}
};
function renderMenu(){
  const grid = $('#menuGrid'); grid.innerHTML='';
  state.settings.menuOrder.forEach(key=>{
    const meta = MENU_META[key]; if(!meta) return;
    if(meta.admin && state.role!=='admin') return;
    const card=document.createElement('div'); card.className='menu-card';
    card.innerHTML=`<div class="ico">${meta.ico}</div><div><div>${meta.title}</div><div class="muted">${key}</div></div>`;
    card.onclick=()=>{
      if(meta.href){ window.open(typeof meta.href==='function'?meta.href():meta.href,'_blank'); return; }
      if(meta.action){ meta.action(); return; }
      if(meta.view===views.config && !requireAdmin()) return;
      show(meta.view);
      if(meta.view===views.agenda && meta.jump==='#record'){ recordatorios24h(); }
    };
    grid.appendChild(card);
  });
  $('#btnGoMenu').onclick=()=> show(views.menu);
}

/* =========================
   AGENDAR CITAS
========================= */
function fillTechsSelect(sel){ sel.innerHTML=state.techs.map(t=>`<option value="${t.id}">${t.nombre}</option>`).join('') }
function fillServicesSelect(sel){ sel.innerHTML=state.services.map(s=>`<option value="${s.id}" data-precio="${s.precio}">${s.nombre}</option>`).join('') }
fillTechsSelect($('#ag_tech')); fillServicesSelect($('#ag_serv'));

$('#btnGuardarCita').onclick=()=>{
  const cliente=$('#ag_cliente').value.trim();
  const tel=$('#ag_tel').value.trim();
  const techId=$('#ag_tech').value;
  const servId=$('#ag_serv').value;
  const fecha=$('#ag_fecha').value, hora=$('#ag_hora').value;
  const notas=$('#ag_notas').value.trim();
  if(!cliente||!tel||!techId||!servId||!fecha||!hora){ alert('Completa todos los campos'); return; }
  const dup = state.appointments.find(a=>a.cliente.toLowerCase()===cliente.toLowerCase() && a.techId===techId && a.fecha===fecha && a.hora===hora);
  if(dup){ alert('Ya existe una cita con la misma persona, técnica, fecha y hora.'); return; }
  const ap = {id:id(), cliente, telefono:tel, techId, servId, fecha, hora, notas, status:'programada'};
  state.appointments.push(ap); saveAll(); alert('Cita guardada'); renderCitas();
};
$('#btnAddCalendar').onclick=()=>{
  const c=$('#ag_cliente').value.trim(), f=$('#ag_fecha').value, h=$('#ag_hora').value;
  const tech=state.techs.find(t=>t.id===$('#ag_tech').value)?.nombre||''; const serv=state.services.find(s=>s.id===$('#ag_serv').value)?.nombre||'';
  if(!c||!f||!h){ alert('Completa cliente, fecha y hora'); return; }
  const start=new Date(f+'T'+h), end=new Date(start.getTime()+60*60*1000);
  const z=d=>d.toISOString().replace(/-|:|\.\d+/g,'');
  const url=`https://calendar.google.com/calendar/r/eventedit?text=${encodeURIComponent(serv+' – '+c)}&details=${encodeURIComponent('Técnica: '+tech)}&dates=${z(start)}/${z(end)}`;
  window.open(url,'_blank');
};
$('#btnWhatsCita').onclick=()=>{
  const telW=state.settings.phoneWhatsApp.replace(/\D/g,'');
  const c=$('#ag_cliente').value.trim(), f=$('#ag_fecha').value, h=$('#ag_hora').value;
  const serv=state.services.find(s=>s.id===$('#ag_serv').value)?.nombre||''; const ubic=state.settings.locationText||'';
  if(!c||!f||!h){ alert('Completa cliente, fecha y hora'); return; }
  const msg=`¡Hola ${c}! 🧡\nTu cita quedó agendada para ${f} a las ${h}.\nServicio: ${serv}\nUbicación: ${ubic}\nSi necesitas cambiarla, avísanos.`;
  window.open(`https://wa.me/${telW}?text=${encodeURIComponent(msg)}`,'_blank');
};
$('#btnFiltrarCitas').onclick=renderCitas;
function renderCitas(){
  const q=$('#filtroCitas').value.trim().toLowerCase();
  const tbody=$('#tablaCitas tbody'); tbody.innerHTML='';
  state.appointments.filter(a=>!q || a.cliente.toLowerCase().includes(q) || (a.fecha||'').includes(q))
    .sort((a,b)=> (a.fecha+a.hora).localeCompare(b.fecha+b.hora))
    .forEach(a=>{
      const tech=state.techs.find(t=>t.id===a.techId)?.nombre||''; const serv=state.services.find(s=>s.id===a.servId)?.nombre||'';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${a.fecha}</td><td>${a.hora}</td><td>${a.cliente}</td><td>${tech}</td><td>${serv}</td>
        <td><span class="pill">${a.status}</span></td>
        <td>
          <button class="btn" data-edit="${a.id}">Editar</button>
          <button class="btn warn" data-ns="${a.id}">${a.status==='no-show'?'Quitar No-Show':'Marcar No-Show'}</button>
          <button class="btn danger" data-del="${a.id}">Borrar</button>
        </td>`;
      tbody.appendChild(tr);
    });
  tbody.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>{
    const a=state.appointments.find(x=>x.id===b.dataset.edit);
    $('#ag_cliente').value=a.cliente; $('#ag_tel').value=a.telefono; $('#ag_tech').value=a.techId; $('#ag_serv').value=a.servId;
    $('#ag_fecha').value=a.fecha; $('#ag_hora').value=a.hora; $('#ag_notas').value=a.notas||'';
    state.appointments=state.appointments.filter(x=>x.id!==a.id); saveAll(); renderCitas(); alert('Edita y vuelve a "Guardar" para re-agendar.');
  });
  tbody.querySelectorAll('[data-ns]').forEach(b=>b.onclick=()=>{ const a=state.appointments.find(x=>x.id===b.dataset.ns); a.status=(a.status==='no-show'?'programada':'no-show'); saveAll(); renderCitas(); renderNoShow(); });
  tbody.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{ if(confirm('¿Borrar cita?')){ state.appointments=state.appointments.filter(x=>x.id!==b.dataset.del); saveAll(); renderCitas(); renderNoShow(); }});
}
function recordatorios24h(){
  const ahora=new Date(), limite=new Date(ahora.getTime()+24*3600*1000);
  const telW=state.settings.phoneWhatsApp.replace(/\D/g,''); const ubic=state.settings.locationText||'';
  const candidatos=state.appointments.filter(a=>{const d=new Date(a.fecha+'T'+(a.hora||'00:00')); return d>=ahora && d<=limite && a.status==='programada';});
  if(!candidatos.length){ alert('No hay citas en las próximas 24h.'); return; }
  const listado=candidatos.map(a=>{ const serv=state.services.find(s=>s.id===a.servId)?.nombre||''; const msg=`Recordatorio: ${a.cliente}, tu cita es el ${a.fecha} a las ${a.hora}.\nServicio: ${serv}\nUbicación: ${ubic}`; return `${a.fecha} ${a.hora} · ${a.cliente} → https://wa.me/${telW}?text=${encodeURIComponent(msg)}`; }).join('\n');
  navigator.clipboard.writeText(listado).catch(()=>{}); alert('Se copiaron enlaces de WhatsApp para recordatorios.');
}

/* =========================
   FECHAS DISPONIBLES
========================= */
fillTechsSelect($('#fd_tech'));
$('#btnCalcularSlots').onclick=()=>{
  const techId=$('#fd_tech').value, fecha=$('#fd_fecha').value;
  const t0=$('#fd_inicio').value, t1=$('#fd_fin').value, mins=+$('#fd_intervalo').value||60;
  if(!techId||!fecha||!t0||!t1){ alert('Completa los campos'); return; }
  const slots=[]; let d=new Date(fecha+'T'+t0), end=new Date(fecha+'T'+t1);
  while(d<end){ slots.push(d.toTimeString().slice(0,5)); d=new Date(d.getTime()+mins*60000) }
  const tbody=$('#tablaSlots tbody'); tbody.innerHTML='';
  slots.forEach(h=>{ const ocupado=state.appointments.some(a=> a.techId===techId && a.fecha===fecha && a.hora===h ); const tr=document.createElement('tr'); tr.innerHTML=`<td>${h}</td><td>${ocupado?'<span class="pill">Ocupado</span>':'Libre'}</td>`; tbody.appendChild(tr); });
};

/* =========================
   NO-SHOW
========================= */
function renderNoShow(){
  const tbody=$('#tablaNoShow tbody'); tbody.innerHTML='';
  state.appointments.filter(a=>a.status==='no-show').sort((a,b)=> (a.fecha+a.hora).localeCompare(b.fecha+b.hora))
    .forEach(a=>{ const tech=state.techs.find(t=>t.id===a.techId)?.nombre||''; const serv=state.services.find(s=>s.id===a.servId)?.nombre||''; const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.fecha}</td><td>${a.hora}</td><td>${a.cliente}</td><td>${tech}</td><td>${serv}</td>`; tbody.appendChild(tr); });
}
renderNoShow();

/* =========================
   COBROS & FACTURAS
========================= */
fillTechsSelect($('#co_tech')); fillServicesSelect($('#co_servSelect'));
let currentItems=[]; function refreshItems(){ const tb=$('#tablaItems tbody'); tb.innerHTML=''; let total=0; currentItems.forEach((it,idx)=>{ const sub=it.qty*it.precio; total+=sub; const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.nombre}</td><td>${it.qty}</td><td>${fmt(it.precio)}</td><td>${fmt(sub)}</td><td><button class="btn danger" data-rm="${idx}">Quitar</button></td>`; tb.appendChild(tr); }); tb.querySelectorAll('[data-rm]').forEach(b=>b.onclick=()=>{ currentItems.splice(+b.dataset.rm,1); refreshItems(); }); $('#co_total').textContent=fmt(total); }
$('#btnAddItem').onclick=()=>{ const opt=$('#co_servSelect').selectedOptions[0]; if(!opt){ alert('Selecciona un servicio'); return; } const nombre=opt.textContent; const precio=+($('#co_precio').value || opt.getAttribute('data-precio') || 0); const qty=+($('#co_qty').value||1); if(!precio||!qty){ alert('Cantidad y precio requeridos'); return; } currentItems.push({nombre, qty, precio}); refreshItems(); };
$('#btnGuardarFactura').onclick=()=>{
  const cliente=$('#co_cliente').value.trim(); const tel=$('#co_tel').value.trim();
  const techId=$('#co_tech').value; const metodo=$('#co_metodo').value;
  if(!cliente||!tel||!techId||!currentItems.length){ alert('Completa cliente/técnica y añade ítems'); return; }
  const total=currentItems.reduce((s,it)=>s+it.qty*it.precio,0);
  const pago={id:id(), facturaNo:state.invoiceSeq++, cliente, telefono:tel, techId, items:JSON.parse(JSON.stringify(currentItems)), metodos:[metodo], total, fechaISO:todayISO(), hora:timeNow()};
  state.payments.push(pago); saveAll(); renderCobros(); sendCuadreWebhook(pago); alert('Factura guardada y enviada a Cuadre (si Webhook está configurado).'); currentItems=[]; refreshItems();
};
function renderCobros(){
  const tb=$('#tablaCobros tbody'); tb.innerHTML='';
  state.payments.slice().reverse().forEach(p=>{ const tech=state.techs.find(t=>t.id===p.techId)?.nombre||''; const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.facturaNo}</td><td>${p.fechaISO} ${p.hora}</td><td>${p.cliente}</td><td>${tech}</td><td>${p.metodos.join(',')}</td><td>${fmt(p.total)}</td><td><button class="btn" data-ver="${p.id}">Ver/Imprimir</button></td>`; tb.appendChild(tr); });
  tb.querySelectorAll('[data-ver]').forEach(b=>b.onclick=()=>{ const p=state.payments.find(x=>x.id===b.dataset.ver); openInvoice(p); });
}
renderCobros();
function openInvoice(p){
  $('#inv_title').textContent='FACTURA'; $('#inv_salon').textContent=state.settings.brandName; $('#inv_logo').src=state.settings.logos.header||'';
  $('#inv_fecha').textContent=p.fechaISO+' '+p.hora; $('#inv_nro').textContent=p.facturaNo; $('#inv_cliente').textContent=p.cliente; $('#inv_tel').textContent=p.telefono;
  const tbody=$('#inv_body'); tbody.innerHTML=''; p.items.forEach((it,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${it.nombre}</td><td>${it.qty}</td><td>${fmt(it.precio)}</td><td>${fmt(it.qty*it.precio)}</td>`; tbody.appendChild(tr); });
  $('#inv_total').textContent=fmt(p.total); $('#inv_footer').textContent=state.settings.footerText||'Gracias por su preferencia.'; $('#invoicePrint').classList.remove('hidden'); setTimeout(()=>window.print(),50); setTimeout(()=>$('#invoicePrint').classList.add('hidden'),200);
}
$('#btnPrintFactura').onclick=()=>{ const ultima=state.payments[state.payments.length-1]; if(!ultima){ alert('No hay facturas guardadas aún'); return; } openInvoice(ultima); };
$('#btnWhatsFactura').onclick=()=>{ const ultima=state.payments[state.payments.length-1]; if(!ultima){ alert('Guarda primero la factura'); return; } const telW=state.settings.phoneWhatsApp.replace(/\D/g,''); const items=ultima.items.map(it=>`${it.qty} x ${it.nombre} (${fmt(it.precio)})`).join('\n'); const msg=`Hola ${ultima.cliente}, aquí el detalle de tu factura #${ultima.facturaNo}:\n${items}\nTOTAL: $${fmt(ultima.total)}\n${state.settings.footerText||''}`; window.open(`https://wa.me/${telW}?text=${encodeURIComponent(msg)}`,'_blank'); };
$('#btnEnviarCuadre').onclick=()=>{ const ultima=state.payments[state.payments.length-1]; if(!ultima){ alert('No hay factura reciente'); return; } sendCuadreWebhook(ultima, true); };
function sendCuadreWebhook(pago, alertar=false){
  const url=(state.settings.webhookURL||'').trim(); if(!url){ if(alertar) alert('Configura el Webhook en Integraciones.'); return; }
  const payload={fecha:pago.fechaISO, hora:pago.hora, cliente:pago.cliente, telefono:pago.telefono, tecnica:state.techs.find(t=>t.id===pago.techId)?.nombre||'', metodos:pago.metodos.join(','), total:pago.total, servicios:pago.items.map(it=>`${it.qty}x ${it.nombre} @${fmt(it.precio)}`).join(' | ')};
  fetch(url,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}).then(r=>r.text()).then(()=>{ if(alertar) alert('Enviado a Cuadre.'); }).catch(()=>{ if(alertar) alert('No se pudo enviar al Webhook.'); });
}
$('#expCobrosJSON').onclick=()=> download('cobros.json', JSON.stringify(state.payments, null, 2));
$('#expCobrosCSV').onclick=()=>{ const rows=[['factura','fecha','hora','cliente','tel','tecnica','metodos','total','items']]; state.payments.forEach(p=>{ rows.push([p.facturaNo,p.fechaISO,p.hora,p.cliente,p.telefono,(state.techs.find(t=>t.id===p.techId)?.nombre||''),p.metodos.join('|'),p.total,p.items.map(it=>`${it.qty}x ${it.nombre} @${fmt(it.precio)}`).join(' / ')]); }); const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n'); download('cobros.csv', csv, 'text/csv'); };
$('#expCobrosPDF').onclick=()=> window.print();

/* =========================
   RENDIMIENTO
========================= */
function calcRend(periodo='mes', techFilter=''){
  const byTech={}; state.payments.forEach(p=>{ const tech=state.techs.find(t=>t.id===p.techId)?.nombre||'Sin técnica'; if(techFilter && tech!==techFilter) return;
    const d=new Date(p.fechaISO), now=new Date(); let keep=true;
    if(periodo==='dia') keep = p.fechaISO===todayISO();
    else if(periodo==='sem') keep = (now-d)/(86400000) <= 7;
    else keep = d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
    if(!keep) return; byTech[tech]=(byTech[tech]||0)+p.total; });
  return byTech;
}
function drawBarChart(canvas, dataMap){
  const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
  const labels=Object.keys(dataMap), values=labels.map(k=>dataMap[k]); if(!labels.length){ ctx.fillStyle='#9bb'; ctx.fillText('Sin datos', 20, 30); return; }
  const pad=40, w=canvas.width-pad*2, h=canvas.height-pad*2; const max=Math.max(...values,1); const bw=w/labels.length*0.7, gap=w/labels.length*0.3;
  ctx.strokeStyle='#456'; ctx.strokeRect(pad,pad,w,h);
  labels.forEach((lab,i)=>{ const x=pad+i*(bw+gap)+gap/2; const barH=(values[i]/max)*(h-20); const y=pad+(h-barH); ctx.fillStyle='#6fb9ff'; ctx.fillRect(x,y,bw,barH); ctx.fillStyle='#9bb'; ctx.font='12px sans-serif'; ctx.fillText(lab, x, pad+h+14); ctx.fillText('$'+fmt(values[i]), x, y-6); });
}
function fillTechsAll(){ fillTechsSelect($('#ag_tech')); fillTechsSelect($('#fd_tech')); fillTechsSelect($('#co_tech')); }
$('#btnCalcRend').onclick=()=>{ const periodo=$('#rn_periodo').value; const tsel=$('#rn_techFiltro').value ? state.techs.find(t=>t.id===$('#rn_techFiltro').value)?.nombre : ''; const data=calcRend(periodo, tsel||''); drawBarChart($('#chartRend'), data); const total=Object.values(data).reduce((s,n)=>s+n,0); $('#rendResumen').textContent=`Total periodo: $${fmt(total)}`; };

/* =========================
   CONFIGURACIÓN
========================= */
function renderConfig(){
  $('#cf_brandName').value=state.settings.brandName; $('#cf_footerText').value=state.settings.footerText||'';
  $('#cf_bg').value=state.settings.colors.bg; $('#cf_topbar').value=state.settings.colors.topbar; $('#cf_btn').value=state.settings.colors.buttons; $('#cf_ink').value=state.settings.colors.ink; $('#cf_font').value=state.settings.font;
  const utb=$('#tablaUsers tbody'); utb.innerHTML=''; state.users.forEach(u=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.user}</td><td>${u.role}</td><td><button class="btn danger" data-u="${u.id}">Borrar</button></td>`; utb.appendChild(tr); });
  utb.querySelectorAll('[data-u]').forEach(b=>b.onclick=()=>{ state.users=state.users.filter(x=>x.id!==b.dataset.u); saveAll(); renderConfig(); });
  const ttb=$('#tablaTechs tbody'); ttb.innerHTML=''; state.techs.forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.nombre}</td><td><button class="btn danger" data-t="${t.id}">Borrar</button></td>`; ttb.appendChild(tr); });
  ttb.querySelectorAll('[data-t]').forEach(b=>b.onclick=()=>{ state.techs=state.techs.filter(x=>x.id!==b.dataset.t); saveAll(); renderConfig(); fillTechsAll(); });
  const stb=$('#tablaSrv tbody'); stb.innerHTML=''; state.services.forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.nombre}</td><td>${fmt(s.precio)}</td><td><button class="btn danger" data-s="${s.id}">Borrar</button></td>`; stb.appendChild(tr); });
  stb.querySelectorAll('[data-s]').forEach(b=>b.onclick=()=>{ state.services=state.services.filter(x=>x.id!==b.dataset.s); saveAll(); renderConfig(); fillServicesSelect($('#ag_serv')); fillServicesSelect($('#co_servSelect')); });
  $('#cf_whatsTel').value=state.settings.phoneWhatsApp||''; $('#cf_whatsUbic').value=state.settings.locationText||''; $('#cf_sheetsURL').value=state.settings.sheetsURL||''; $('#cf_webhookURL').value=state.settings.webhookURL||'';
}
$('#btnAddUser').onclick=()=>{ const u=$('#cf_user').value.trim(), p=$('#cf_pass').value, r=$('#cf_role').value; if(!u||!p){ alert('Usuario y contraseña requeridos'); return; } if(state.users.some(x=>x.user===u)){ alert('Usuario ya existe'); return; } state.users.push({id:id(), user:u, passHash:hash(p), role:r}); saveAll(); renderConfig(); $('#cf_user').value=''; $('#cf_pass').value=''; };
$('#btnAddTech').onclick=()=>{ const n=$('#cf_tech').value.trim(); if(!n) return; state.techs.push({id:id(), nombre:n, activo:true}); saveAll(); renderConfig(); fillTechsAll(); $('#cf_tech').value=''; };
$('#btnAddSrv').onclick=()=>{ const n=$('#cf_srvNombre').value.trim(); const pr=+$('#cf_srvPrecio').value; if(!n||!pr){ alert('Servicio y precio requeridos'); return; } state.services.push({id:id(), nombre:n, precio:pr, activo:true}); saveAll(); renderConfig(); fillServicesSelect($('#ag_serv')); fillServicesSelect($('#co_servSelect')); $('#cf_srvNombre').value=''; $('#cf_srvPrecio').value=''; };
$('#cf_logoHeader').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; imgToDataURL(f,(url)=>{ state.settings.logos.header=url; saveAll(); setTheme(); }); };
$('#cf_logoFooter').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; imgToDataURL(f,(url)=>{ state.settings.logos.footer=url; saveAll(); setTheme(); }); };
$('#cf_bgImage').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; imgToDataURL(f,(url)=>{ state.settings.bgImage=url; saveAll(); document.body.style.backgroundImage=`url(${url})`; document.body.style.backgroundSize='cover'; document.body.style.backgroundAttachment='fixed'; }); };
['cf_brandName','cf_footerText','cf_font'].forEach(id=> $('#'+id).onchange=()=>{ state.settings.brandName=$('#cf_brandName').value.trim()||state.settings.brandName; state.settings.footerText=$('#cf_footerText').value||''; state.settings.font=$('#cf_font').value||'system-ui'; saveAll(); setTheme(); });
['cf_bg','cf_topbar','cf_btn','cf_ink'].forEach(id=> $('#'+id).onchange=()=>{ state.settings.colors.bg=$('#cf_bg').value; state.settings.colors.topbar=$('#cf_topbar').value; state.settings.colors.buttons=$('#cf_btn').value; state.settings.colors.ink=$('#cf_ink').value; saveAll(); setTheme(); });
['cf_whatsTel','cf_whatsUbic','cf_sheetsURL','cf_webhookURL'].forEach(id=> $('#'+id).onchange=()=>{ state.settings.phoneWhatsApp=$('#cf_whatsTel').value; state.settings.locationText=$('#cf_whatsUbic').value; state.settings.sheetsURL=$('#cf_sheetsURL').value; state.settings.webhookURL=$('#cf_webhookURL').value; saveAll(); $('#cuadreLink').href=state.settings.sheetsURL||'#'; });
$('#btnExpConfig').onclick=()=> download('config.json', JSON.stringify(state.settings,null,2));
$('#btnImpConfig').onclick=()=> $('#cf_importFile').click();
$('#cf_importFile').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ state.settings=JSON.parse(r.result); saveAll(); setTheme(); renderMenu(); alert('Configuración importada'); }catch{ alert('JSON inválido') } }; r.readAsText(f); };
$('#btnPrintConfig').onclick=()=> window.print();
$('#btnExpDatos').onclick=()=>{ const datos={appointments:state.appointments, payments:state.payments, noShows:state.appointments.filter(a=>a.status==='no-show'), logs:state.logs}; download('datos.json', JSON.stringify(datos, null, 2)); };
$('#btnExpDatosCSV').onclick=()=>{ const rows=[['tipo','fecha','hora','cliente','tel','tecnica','detalle','monto']]; state.appointments.forEach(a=>{ rows.push(['cita',a.fecha,a.hora,a.cliente,a.telefono,(state.techs.find(t=>t.id===a.techId)?.nombre||''),(state.services.find(s=>s.id===a.servId)?.nombre||''),'']); }); state.payments.forEach(p=>{ rows.push(['cobro',p.fechaISO,p.hora,p.cliente,p.telefono,(state.techs.find(t=>t.id===p.techId)?.nombre||''),p.items.map(it=>`${it.qty}x ${it.nombre}`).join(' / '), p.total]); }); const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n'); download('datos.csv', csv, 'text/csv'); };

/* =========================
   ENLACES Y PWA
========================= */
$$('[data-back]').forEach(b=> b.onclick=()=> show(views.menu) );
$('#cuadreLink').href = state.settings.sheetsURL||'#';
if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js'); }); }
</script>
</body>
</html>
